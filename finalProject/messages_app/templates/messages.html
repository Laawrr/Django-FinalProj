{% extends "base.html" %}

{% block title %}Messages{% endblock %}

{% block navlinks %}
<div class="relative">
  <button id="userDropdown" class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 focus:outline-none">
    <span>{{ user.username }}</span>
    <i class="lucide-chevron-down h-4 w-4"></i>
  </button>
  <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
    <a href="{% url 'edit-user' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
      <i class="lucide-user mr-2 h-4 w-4 inline-block"></i>
      Profile
    </a>
    <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
      <i class="lucide-log-out mr-2 h-4 w-4 inline-block"></i>
      Logout
    </a>
  </div>
</div>
{% endblock %}

{% block body %}
<!-- Main Content -->
<main class="flex-grow flex flex-col md:flex-row">
  <!-- Toggle button for user list on small screens -->
  <button id="toggleUserList"
    class="md:hidden fixed bottom-4 left-4 z-50 bg-indigo-600 text-white p-2 rounded-full shadow-lg">
    <i class="lucide-users"></i>
  </button>


  <!-- Right Side - Chat Area -->
  <div class="flex-1 flex flex-col bg-white">
    <div id="messageContainer" class="flex-grow overflow-y-auto p-4">
      {% if not messages %}
      <p class="text-gray-500 text-center">No messages yet. Start the conversation!</p>
      {% else %}
      {% for message in messages %}
      <div class="message p-2 border-b {% if message.user == user %}text-right{% else %}text-left{% endif %}">
        <strong>{{ message.user.username }}:</strong>
        <p>{{ message.content }}</p>
        <span class="text-gray-500 text-xs">{{ message.timestamp }}</span>
      </div>
      {% endfor %}
      {% endif %}
    </div>
    <div class="border-t bg-white p-4">
      <form id="messageForm" class="flex gap-2">
        {% csrf_token %}
        <input type="text" name="content"
        class="flex-1 px-4 py-2 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
          placeholder="Type a message..." />
        <button type="submit"
        class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        Send</span>
        </button>
      </form>
    </div>
  </div>
</main>
<script>
 // Toggle user menu
 const userDropdown = document.getElementById("userDropdown");
      const userMenu = document.getElementById("userMenu");
      if (userDropdown && userMenu) {
        userDropdown.addEventListener("click", () => {
          userMenu.classList.toggle("hidden");
        });

        // Close the menu when clicking outside
        document.addEventListener("click", (event) => {
          if (
            !userDropdown.contains(event.target) &&
            !userMenu.contains(event.target)
          ) {
            userMenu.classList.add("hidden");
          }
        });
      }

      // Toggle user list on small screens
      const toggleUserList = document.getElementById("toggleUserList");
      const userList = document.getElementById("userList");

      toggleUserList.addEventListener("click", () => {
        userList.classList.toggle("-translate-x-full");
      });

      // Close user list when clicking outside on small screens
      document.addEventListener("click", (event) => {
        const isSmallScreen = window.innerWidth < 768; // md breakpoint
        if (
          isSmallScreen &&
          !userList.contains(event.target) &&
          event.target !== toggleUserList
        ) {
          userList.classList.add("-translate-x-full");
        }
      });

      document.addEventListener('DOMContentLoaded', function () {
  // Fetch messages only for the current user (authenticated user)
  fetchMessages();

  function fetchMessages() {
    fetch("{% url 'message-api' %}")
      .then(response => response.json())
      .then(data => {
        // Extract the decrypted content array
        const messages = Array.isArray(data.decrypted_content) ? data.decrypted_content : [];

        const messageContainer = document.getElementById("messageContainer");

        if (messages.length === 0) {
          messageContainer.innerHTML = "<p class='text-gray-500 text-center'>No messages yet. Start the conversation!</p>";
        } else {
          messageContainer.innerHTML = "";  // Clear existing messages
          messages.forEach(message => {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", "p-2", "border-b", message.user === '{{ user.username }}' ? 'text-right' : 'text-left');
            messageElement.innerHTML = `
              <strong>${message.user}:</strong>
              <p>${message.content}</p>
              <span class="text-gray-500 text-xs">${message.timestamp}</span>
            `;
            messageContainer.appendChild(messageElement);
          });
        }

        // Scroll to the bottom of the message container after updating messages
        setTimeout(() => {
          messageContainer.scrollTop = messageContainer.scrollHeight;
        }, 0);
      })
      .catch(error => {
        console.error('Error fetching messages:', error);
      });
  }

  // Handle message form submission as JSON
  document.getElementById('messageForm').addEventListener('submit', function (event) {
    event.preventDefault(); // Prevent default form submission

    const content = document.querySelector('input[name="content"]').value;

    // Check if content is empty
    if (!content.trim()) {
      alert("Message cannot be empty!");
      return;
    }

    const data = {
      content: content
    };

    fetch("{% url 'message-api' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value, // Include CSRF token
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(data => {
        // console.log('Message sent:', data);
        fetchMessages();  // Fetch updated messages
        // Clear the input field after sending the message
        document.querySelector('input[name="content"]').value = '';
      })
      .catch(error => {
        console.error('Error sending message:', error);
      });
  });
});

</script>

{% endblock %}